<!DOCTYPE html>
<html lang="en">
<head>
  <title>AR.js A-Frame Location-based</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
  <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
  <script type="text/javascript">
    var latitude;
    var longitude;
    let avClicks = 3;

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        document.getElementById("locationInfo").innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    function showPosition(position) {
      latitude = position.coords.latitude;
      longitude = position.coords.longitude;
    }

    function calculateNewCoordinates(lat, lon, distance, angle) {
      // Convert latitude and longitude from degrees to radians
      let latRad = lat * Math.PI / 180;
      let lonRad = lon * Math.PI / 180;

      // Earth radius in meters
      let R = 6378137;

      // Calculate the new latitude
      let newLat = Math.asin(Math.sin(latRad) * Math.cos(distance / R) + Math.cos(latRad) * Math.sin(distance / R) * Math.cos(angle));

      // Calculate the new longitude
      let newLon = lonRad + Math.atan2(Math.sin(angle) * Math.sin(distance / R) * Math.cos(latRad), Math.cos(distance / R) - Math.sin(latRad) * Math.sin(newLat));

      // Convert the new latitude and longitude from radians to degrees
      newLat = newLat * 180 / Math.PI;
      newLon = newLon * 180 / Math.PI;

      return {latitude: newLat, longitude: newLon};
    }

    function PlanTree() {
      getLocation();
      if (avClicks !== 0) {
        avClicks--;
        const scene = document.querySelector('a-scene');
        const newEntity = document.createElement('a-entity');
        newEntity.setAttribute('material', 'color: green');
        newEntity.setAttribute('geometry', 'primitive: cone; radiusBottom: 1; radiusTop: 0; height: 2');

        // Get the camera direction
        const camera = document.querySelector('a-camera');
        const rotation = camera.object3D.rotation;

        // Calculate the angle in radians
        let angle = rotation.y;

        // Convert angle from radians to degrees
        angle = angle * (180 / Math.PI);

        // Calculate the new coordinates (1 meter ahead of the camera)
        const newCoords = calculateNewCoordinates(latitude, longitude, 1, angle);
        newEntity.setAttribute('gps-new-entity-place', `latitude: ${newCoords.latitude}; longitude: ${newCoords.longitude}`);
        scene.appendChild(newEntity);

        let myButton = document.getElementById("myButton");
        myButton.value = "Plan Tree remaining times:" + avClicks;
      }
      if (avClicks === 0) {
        let myButton = document.getElementById("myButton");
        myButton.style.backgroundColor = 'grey';
      }
    }

    window.onload = function () {
      getLocation();
      let myButton = document.getElementById("myButton");
      myButton.value = "Plan Tree remaining times:" + avClicks;
    }
  </script>
  <style>
    #myButton {
      position: absolute;
      bottom: 20px; /* Position 20px from the bottom */
      left: 50%; /* Center horizontally */
      transform: translateX(-50%); /* Adjust position to center */
      padding: 15px 30px;
      font-size: 18px;
      background-color: green;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1; /* Make sure the button is on top of the AR scene */
    }
  </style>
</head>
<body>

<a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false' renderer='antialias: true; alpha: true'>
  <a-camera gps-new-camera='gpsMinDistance: 0.1'></a-camera>
</a-scene>
<input type="button" id="myButton" onclick="PlanTree()" value=""/>
</body>
</html>
